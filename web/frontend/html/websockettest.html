<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket JWT Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h2 {
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      textarea, input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      #log {
        background-color: #f8f9fa;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }
      .status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 15px;
        background-color: #f1f1f1;
        cursor: pointer;
        margin-right: 5px;
        border-radius: 4px 4px 0 0;
      }
      .tab.active {
        background-color: #4CAF50;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
<body>
  <div class="container">
    <h2>WebSocket JWT Test</h2>
    
    <div class="tabs">
      <div class="tab active" onclick="showTab('connection')">Connection</div>
      <div class="tab" onclick="showTab('testing')">Testing</div>
      <div class="tab" onclick="showTab('debug')">Debug</div>
    </div>
    
    <div id="connection" class="tab-content active">
      <div class="form-group">
        <label for="token">JWT Token:</label>
        <textarea id="token" rows="4" cols="50" placeholder="Paste your JWT token here"></textarea>
      </div>
      
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="e.g., user1">
      </div>
      
      <div class="form-group">
        <label>Connection Options:</label>
        <div>
          <input type="checkbox" id="ignoreHttps" checked>
          <label for="ignoreHttps">Ignore HTTPS certificate errors (for self-signed certs)</label>
        </div>
      </div>
      
      <button onclick="connectSocket()">Connect & Register</button>
      <button onclick="disconnectSocket()" style="background-color: #dc3545;">Disconnect</button>
      
      <div id="connectionStatus" class="status disconnected">
        Status: Disconnected
      </div>
    </div>
    
    <div id="testing" class="tab-content">
      <div class="form-group">
        <label for="eventName">Event Name:</label>
        <input type="text" id="eventName" value="message">
      </div>
      
      <div class="form-group">
        <label for="eventData">Event Data (JSON):</label>
        <textarea id="eventData" rows="4" cols="50" placeholder='{
  "key": "value"
}'></textarea>
      </div>
      
      <button onclick="sendEvent()">Send Event</button>
      
      <div class="form-group" style="margin-top: 20px;">
        <label>Quick Commands:</label>
        <button onclick="pingServer()">Ping Server</button>
        <button onclick="getUserList()">Get User List</button>
        <button onclick="debugConnection()">Connection Debug</button>
      </div>
    </div>
    
    <div id="debug" class="tab-content">
      <div class="form-group">
        <label>Auto-Login (Test Only):</label>
        <div>
          <input type="text" id="testUsername" placeholder="Username">
          <input type="text" id="testPassword" placeholder="Password">
          <button onclick="loginAndConnect()">Login & Connect</button>
        </div>
      </div>
      
      <div class="form-group">
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="testConnection()">Test Connection</button>
      </div>
    </div>
    
    <h3>Messages:</h3>
    <pre id="log"></pre>
  </div>

  <script>
    let socket;
    let activeTab = 'connection';
    
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show the selected tab
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`.tab:nth-child(${tabName === 'connection' ? 1 : tabName === 'testing' ? 2 : 3})`).classList.add('active');
      activeTab = tabName;
    }

    function logMessage(msg, isError = false) {
      const logBox = document.getElementById("log");
      const timestamp = new Date().toISOString().substring(11, 19);
      let message = `[${timestamp}] ${msg}`;
      
      if (isError) {
        message = `[${timestamp}] ERROR: ${msg}`;
      }
      
      logBox.textContent += message + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }
    
    function clearLog() {
      document.getElementById("log").textContent = "";
    }
    
    function updateConnectionStatus(isConnected) {
      const statusElem = document.getElementById("connectionStatus");
      if (isConnected) {
        statusElem.className = "status connected";
        statusElem.textContent = "Status: Connected";
      } else {
        statusElem.className = "status disconnected";
        statusElem.textContent = "Status: Disconnected";
      }
    }

    function connectSocket() {
      const token = document.getElementById("token").value;
      const username = document.getElementById("username").value;
      const ignoreHttps = document.getElementById("ignoreHttps").checked;
      
      if (!token) {
        logMessage("JWT token is required", true);
        return;
      }
      
      if (!username) {
        logMessage("Username is required", true);
        return;
      }

      logMessage("Connecting to WebSocket server...");
      
      const url = "https://localhost:5000";
      
      try {
        // Close any existing connection
        if (socket) {
          socket.disconnect();
        }
        
        // Create new connection
        socket = io(url, {
          auth: {
            token: token
          },
          transports: ["websocket"],
          rejectUnauthorized: !ignoreHttps, // Allow self-signed certs when checkbox is checked
          secure: true
        });

        // Register connection events
        socket.on("connect", () => {
          logMessage("WebSocket connection established!");
          updateConnectionStatus(true);
          
          // Register user after connection
          socket.emit("register_user", {
            token: token,
            username: username
          });
          
          logMessage(`Sent register_user event for: ${username}`);
        });

        socket.on("response", (data) => {
          logMessage(`RESPONSE: ${JSON.stringify(data)}`);
        });

        socket.on("user_status", (data) => {
          logMessage(`USER STATUS: ${JSON.stringify(data)}`);
        });
        
        socket.on("user_count", (data) => {
          logMessage(`USER COUNT: ${data.count} users online`);
        });

        socket.on("disconnect", () => {
          logMessage("WebSocket disconnected");
          updateConnectionStatus(false);
        });

        socket.on("connect_error", (err) => {
          logMessage(`Connection error: ${err.message}`, true);
          updateConnectionStatus(false);
        });

        socket.on("error", (err) => {
          logMessage(`Socket error: ${err.message}`, true);
        });
        
        socket.on("debug_info", (data) => {
          logMessage(`DEBUG INFO: ${JSON.stringify(data, null, 2)}`);
        });
        
        socket.on("force_disconnect", (data) => {
          logMessage(`Forced disconnect: ${JSON.stringify(data)}`);
          updateConnectionStatus(false);
        });
        
        socket.on("pong_manual", (data) => {
          logMessage(`PONG: ${JSON.stringify(data)}`);
        });
        
        socket.on("online_users", (data) => {
          logMessage(`ONLINE USERS: ${JSON.stringify(data)}`);
        });
        
      } catch (err) {
        logMessage(`Error creating connection: ${err.message}`, true);
      }
    }
    
    function disconnectSocket() {
      if (socket) {
        logMessage("Disconnecting from WebSocket server...");
        socket.disconnect();
        updateConnectionStatus(false);
      } else {
        logMessage("No active connection to disconnect", true);
      }
    }
    
    function sendEvent() {
      if (!socket || !socket.connected) {
        logMessage("Not connected to server", true);
        return;
      }
      
      const eventName = document.getElementById("eventName").value;
      let eventData;
      
      try {
        eventData = JSON.parse(document.getElementById("eventData").value);
      } catch (e) {
        logMessage("Invalid JSON data", true);
        return;
      }
      
      logMessage(`Sending event '${eventName}': ${JSON.stringify(eventData)}`);
      socket.emit(eventName, eventData);
    }
    
    function pingServer() {
      if (!socket || !socket.connected) {
        logMessage("Not connected to server", true);
        return;
      }
      
      logMessage("Sending ping to server");
      socket.emit("ping_manual");
    }
    
    function getUserList() {
      if (!socket || !socket.connected) {
        logMessage("Not connected to server", true);
        return;
      }
      
      logMessage("Requesting online users");
      socket.emit("get_online_users");
    }
    
    function debugConnection() {
      if (!socket || !socket.connected) {
        logMessage("Not connected to server", true);
        return;
      }
      
      logMessage("Requesting debug information");
      socket.emit("debug_connection");
    }
    
    async function loginAndConnect() {
      const username = document.getElementById("testUsername").value;
      const password = document.getElementById("testPassword").value;
      
      if (!username || !password) {
        logMessage("Username and password are required", true);
        return;
      }
      
      try {
        logMessage(`Logging in as ${username}...`);
        
        const response = await fetch('https://localhost:5000/login-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        if (!response.ok) {
          throw new Error(`Login failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        logMessage(`Login successful! Token: ${data.token.substring(0, 15)}...`);
        
        // Set the token and username in the connection form
        document.getElementById("token").value = data.token;
        document.getElementById("username").value = username;
        
        // Show the connection tab
        showTab('connection');
        
        // Connect automatically
        connectSocket();
        
      } catch (err) {
        logMessage(`Login error: ${err.message}`, true);
      }
    }
    
    function testConnection() {
      const url = "https://localhost:5000";
      logMessage(`Testing connection to ${url}...`);
      
      fetch(url, { 
        method: 'GET'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        logMessage(`Connection test succeeded! Status: ${response.status}`);
        return response.text();
      })
      .then(data => {
        logMessage(`Response size: ${data.length} bytes`);
      })
      .catch(error => {
        logMessage(`Connection test failed: ${error.message}`, true);
      });
    }
  </script>
</body>
</html>
